rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Master Bypass for Super Admin ---
    // This MUST be first to avoid helper function dependency issues during evaluation
    match /{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == 'sljuwV64DYb9AnZJ8WxBmKRblYz1';
    }

    // --- Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return request.auth != null && request.auth.uid == 'sljuwV64DYb9AnZJ8WxBmKRblYz1';
    }

    // Check if the user has a user_boxes entry for the specific box
    function isMemberOfBox(boxId) {
      return isSignedIn() && (
        isSuperAdmin() || 
        exists(/databases/$(database)/documents/user_boxes/$(request.auth.uid + '_' + boxId))
      );
    }

    // Check role within a specific box using user_boxes
    function getRoleInBox(boxId) {
       let membershipPath = /databases/$(database)/documents/user_boxes/$(request.auth.uid + '_' + boxId);
       return exists(membershipPath) ? get(membershipPath).data.role : 'member';
    }

    function isAdminOfBox(boxId) {
      return isSuperAdmin() || (isMemberOfBox(boxId) && getRoleInBox(boxId) == 'admin');
    }

    function isCoachOfBox(boxId) {
       let role = getRoleInBox(boxId);
       return isSuperAdmin() || (isMemberOfBox(boxId) && (role == 'coach' || role == 'admin'));
    }

    // --- Rules ---

    // 1. User Boxes (Memberships)
    // ID format: {userId}_{boxId}
    match /user_boxes/{membershipId} {
        // User can read their own memberships
        allow read: if isSignedIn() && (
            resource.data.userId == request.auth.uid ||
            isSuperAdmin() ||
            // Admins of the box can read memberships for that box
            isAdminOfBox(resource.data.boxId)
        );
        
        // Allow creation if:
        // 1. User is creating their own membership record (needed for joining via invitation)
        // 2. User is Super Admin
        // 3. User is Admin of the target Box
        allow create: if isSignedIn() && (
             request.resource.data.userId == request.auth.uid ||
             isSuperAdmin() ||
             isAdminOfBox(request.resource.data.boxId)
        );

        // Only Super Admin or Box Admin can update/delete memberships
        allow update, delete: if isSignedIn() && (
             isSuperAdmin() ||
             isAdminOfBox(resource.data.boxId)
        );
    }

    // 2. Users Collection
    match /users/{userId} {
      allow read: if isOwner(userId) || isSuperAdmin() || isSignedIn(); 
      // Optimized: Allow reading basic user profiles for search/display in gym context
      
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      allow update: if isOwner(userId) || isSuperAdmin();

      match /history/{historyId} {
        allow read, write: if isOwner(userId);
      }
    }

    // 3. BOX (Gym) Documents
    match /boxes/{boxId} {
      allow read: if isSignedIn(); // Allow reading box info to choose/join
      allow write: if isSuperAdmin(); // Box creation/deletion is restricted to Super Admin

      // Box-specific Classes
      match /classes/{classId} {
        allow read: if isMemberOfBox(boxId);
        allow write: if isCoachOfBox(boxId);

        // Class Leaderboard (Scores)
        match /scores/{scoreUserId} {
          allow read: if isMemberOfBox(boxId);
          allow write: if isOwner(scoreUserId) || isCoachOfBox(boxId);
        }
      }
      
      // Legacy WODs inside classes? Or Separate? 
      // Assuming structure follows classes for now.
    }
    
    // 4. Invitations
    match /invitations/{inviteId} {
      allow read: if isSignedIn(); 
      allow create, update, delete: if isSignedIn(); 
      // Simplified for implementation phase, verify logic in app later
    }

    // 5. Personal Data (Logs, Calendar, PRs)
    match /logs/{logId} {
      allow read, write: if isOwner(resource.data.uid) || isOwner(request.resource.data.uid);
    }
    match /calendar_entries/{entryId} {
      // 1. Personal entries (uid based)
      allow read, write: if 
        (resource != null && isOwner(resource.data.uid)) || 
        (request.resource != null && isOwner(request.resource.data.uid));
      
      // 2. Class entries (Shared, box members and coaches)
      allow read: if 
        (resource != null && resource.data.type == 'class' && isMemberOfBox(resource.data.boxId));
      
      allow write: if 
        (request.resource != null && request.resource.data.type == 'class' && isCoachOfBox(request.resource.data.boxId)) ||
        (resource != null && resource.data.type == 'class' && isCoachOfBox(resource.data.boxId));
    }
    match /prs/{prId} {
      allow read, write: if isOwner(resource.data.uid) || isOwner(request.resource.data.uid);
    }

    // 6. Mail (Firebase Trigger Email Extension)
    match /mail/{mailId} {
      allow create: if isSignedIn();
    }
  }
}
